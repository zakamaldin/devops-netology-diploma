# Дипломная работа по курсу DevOps
Содержит 2 terraform-проекта:

- `diploma_configure` - создает обвязку для хранения состояния основного проекта, несколько сервисных аккаунтов и s3-бакет для хранения стейта и БД для блокировок
- `diploma_project` - основной проект, содержащий в себе файлы для развертываня сетей, лкастера k8s и jenkins

## Порядок запуска

Для поднятия инфраструктуры дипломной работы - необходимо последовательно выполнить шаги в этапах конфигурирования и запуска

### Конфигурироание

Отдельный проект для создания бакета `s3`, БД `Managed Service for YDB` для блокировок `state`, ролей и выдачи прав

Необходимо также выполнить несколько ручных операция для переноса `state` основного проекта в бакет `s3`

Этап конфигурирования необязателен, если не планируется хранить `state` в бакете `s3`

0. Иницировать `yc`
1. Перейти в конфигурационный проект `diploma_configure`
2. Выполинть `terraform init`
3. Выполнить `terraform apply`
4. Перейти на вкладку `Навигация` в созданнную БД `zakamaldin-diploma-state-ydb` в `YandexCloud`
5. Создать таблицу со следующим параметрами:
    - Имя: `zakamaldin-diploma-tflock`
    - Тип: `Документная таблица`
    - Колонка
      - Имя: `LockID`
      - Тип: `String`
      - Ключ партиционирования: `True`
6. Перейти в основной проект `diploma_project`
7. Выполинть `terraform init` для первоначальной инициализации
8. Раскомментировать блок `backend "s3"` в `providers.tf`
9. Заполнить параметр `dynamodb_endpoint` значением из вывода конфигурационного проекта
10. Выполнить команду `terraform init` из созданного файла `init_s3_backend_command.sh` в конфигурационном проекте

### Запуск

Запуск дипломного проекта разделен на несколько этапов:
- Поднятие инфраструктуры
- Настройка `Jenkins`
- Настройка `GiHub` 
- Push в репозиторий тестового приложения

Убедиться, что есть 16 свободных внешних ip и 64 ядра в квотах Yandex Cloud, пока решил не прятать все за NAT

#### Инфраструктура

Этап поднятия инфраструктуры дипломной работы включает в себя создание следущих ресурсов через `terraform`:
- сети
- `k8s` кластер
- `Yandex Cloud Registry`
- виртуальные машины для `Jenkins`
- сервисные аккаунты `Yandex Cloud` с необходимыми правами
- обновление локального `kubeconfig` для возможости подключения к `k8s` кластеру
- создание `kubeconfig` для агентов `Jenkins` для подключения к `k8s` кластеру
- `inventory` для настройки вирутальных машин `Jenkins` через `ansible-playbook`
- вывод необходимых параметров для дальнейшей работы

##### Шаги:
0. Иницировать `yc`
1. Перейти в основной проект `diploma_project`
2. Выполинть `terraform init` для первоначальной инициализации 
3. Выполнить шаги 8 - 10 из этапа конфигурирования если требуется хранить `state` в бакете `s3` (Опционально)
4. Выполнить `terraform apply`
Выполнение завершится с ошибкой, так как используется провайдер `helm` для установки стека мониторинга и ингресс контроллера.
Падает так как инициализация провайдера происходит до создания кластера `k8s` и обновления локального `kubeconfig`
5. Запустить `terraform apply` повторно для корректной установки стека мониторинга и ингресс контроллера
6. Найти в поднятом `k8s`-кластере сервис с типом `LoadBalancer` и порописать его у себя в `/etc/hosts`, следуя подскаске из вывода `update_etc_hosts`

##### Вывод после успешного выполнения `terraform apply`:
- alertmanager_url - ссылка на `AlertManager`
- grafana_url - ссылка на `Grafana` (admin:admin)
- prometheus_url - ссылка на `Prometheus`
- registry_id - идентификатор хранилища `Registry`, необходимо использовать как параметр `Jenkinsfile` тестового проекта
- setup_jenkins_command - команда запуска `ansible-playbook'а` для настройки виртуальных машин `Jenkins`
- update_etc_hosts - напомнинание о необходимости добавить внешний IP-адрес ингресс контроллера в `/etc/hosts`

#### Jenkins

После поднятия инфраструктуры будет поднято 4 ВМ `Jenkins`:
- 1 мастер
- 3 агента

Для настройки всех нод необходимо:
1. Запустить `ansible-playbook` командой из вывода поднятия инфраструктуры `setup_jenkins_command`:  
   ```bash
   ansible-playbook jenkins/setup_jenkins.yml -i jenkins/inventory/jenkins/hosts.yml
   ```
2. `ansible-playbook` остановит выполнение после шага `Print pass`
  В шаге будет предложено перейти в `UI` мастер-ноды `Jenkins` и ввести инициализирующий пароль для дальнейшей настройки через `UI`
3. Ввести инициализирующий пароль, установить предложенные по умолчанию плагины, дождаться конца установки
4. Перейти в UI
5. Войти в настройки аккаунта
6. Сгенерировать API-токен
7. Вставить токен в терминал, где стоит на паузе `ansible-playbook`

Дальнейшая установка выполняется с использованием токена в автоматическом режиме:
- добавляется приватный `ssh` ключ в хранилище секретов `Jenkins` для коннекта к агентам
- добавляется `registry-token` в хранилище секретов `Jenkins` для логина в `Yandex Cloud Registry`
- мастер нода переводится в состояние "выключен", чтобы на ней не производились сборки
- добавляются агенты `Jenkins` с подключением по `ssh`  с использованием, созданного ранее секрета
- создается джоба `diploma`, настроенная на репозиторий тестового приложения

#### Настройка GitHub

Необходимо настроить `webhook` для репозитория с тестовым приложением, чтобы при выполнеии операции `push` в репозаиторий, производился запуск джобы `diploma`

#### Push в репозиторий тестового приложения

Необходимо подставить актуальный идентификатор `Yandex Cloud Registry` в поле `REGISTRY_ID` в файле `Jenkinsfile` тестового проекта, закоммитить изменения и выполнить `push`

`Github` выполнит запрос на `webkhook` нашего `Jenkins'а` и `Jenkins` запустит джобу с шагами:
- сборки образа
- публикации образа в `Yandex Cloud Registry`
- раскатки приложения в `k8s` кластер
- очистки агента